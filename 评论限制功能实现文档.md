# 评论限制功能实现文档

## 功能需求

为评论功能添加以下限制：
- 同个昵称在一个链接里面，只能发两篇评论
- 这两篇评论内容不能完全一样

## 现有系统架构

### 数据模型
- `ImageReview` 模型存储审核记录
- `imageType: 'comment'` 表示评论类型
- `noteUrl` 字段存储小红书笔记链接
- `userNoteInfo.comment` 字段存储用户填写的评论内容
- `status` 字段表示审核状态（'completed', 'manager_approved' 等表示已通过）

### 提交流程
- 用户通过 `/tasks/batch-submit` API 提交评论
- 系统在 `server/routes/client.js` 的批量提交端点中处理评论验证

## 实现方案

### 1. 在AI审核通过后添加昵称+链接限制

参考笔记类型的昵称7天限制验证模式，在 `server/routes/client.js` 的 `/tasks/batch-submit` 端点中，针对评论类型在AI审核通过后添加验证：

```javascript
// 在AI审核通过后，检查评论昵称+链接限制
if (aiReviewResult && aiReviewResult.aiReview && aiReviewResult.aiReview.passed && aiReviewResult.aiReview.confidence >= 0.9) {
  console.log('🎉 AI审核通过，开始检查评论昵称+链接限制...');

  // 获取昵称信息：优先使用用户提交的noteAuthor
  let authorToCheck = null;
  if (Array.isArray(noteAuthor) && noteAuthor.length > 0) {
    authorToCheck = noteAuthor[0].trim(); // 取第一个昵称
  } else if (typeof noteAuthor === 'string' && noteAuthor.trim()) {
    authorToCheck = noteAuthor.trim();
  }

  // 如果用户没提供昵称，尝试从评论验证结果中获取
  if (!authorToCheck && aiReviewResult.commentVerification?.foundComments?.length > 0) {
    authorToCheck = aiReviewResult.commentVerification.foundComments[0].author;
  }

  if (authorToCheck) {
    // 检查该昵称在该链接下已经有多少条评论
    const existingComments = await ImageReview.find({
      'aiParsedNoteInfo.author': authorToCheck,
      imageType: 'comment',
      noteUrl: noteUrl.trim(),
      status: { $in: ['manager_approved', 'completed'] }
    });

    console.log(`评论昵称限制检查 - 昵称:"${authorToCheck}", 链接:${noteUrl}, 现有评论数:${existingComments.length}`);

    if (existingComments.length >= 2) {
      console.log(`❌ 评论昵称限制触发：昵称"${authorToCheck}"在该链接下已有${existingComments.length}条评论`);

      // 拒绝审核通过
      reviewData.status = 'manager_rejected';
      reviewData.rejectionReason = `昵称"${authorToCheck}"在该链接下最多只能发布2条评论`;

      // 添加拒绝历史
      reviewData.auditHistory.push({
        operator: null, // AI审核
        operatorName: 'AI审核系统',
        action: 'manager_reject',
        comment: `AI自动审核拒绝：${reviewData.rejectionReason}`,
        timestamp: new Date()
      });

      console.log(`❌ 评论昵称限制触发：昵称"${authorToCheck}"在链接${noteUrl}下已有${existingComments.length}条评论`);

      // 跳过后续处理
      const review = await new ImageReview(reviewData).save();
      return review;
    }

    // 如果已有评论，检查内容是否重复
    if (existingComments.length > 0) {
      const hasDuplicateContent = existingComments.some(review => {
        return review.userNoteInfo &&
               review.userNoteInfo.comment &&
               review.userNoteInfo.comment.trim() === commentContent.trim();
      });

      if (hasDuplicateContent) {
        console.log(`❌ 评论内容重复：昵称"${authorToCheck}"在该链接下的评论内容重复`);

        // 拒绝审核通过
        reviewData.status = 'manager_rejected';
        reviewData.rejectionReason = `评论内容不能与该链接下的其他评论完全相同`;

        // 添加拒绝历史
        reviewData.auditHistory.push({
          operator: null, // AI审核
          operatorName: 'AI审核系统',
          action: 'manager_reject',
          comment: `AI自动审核拒绝：${reviewData.rejectionReason}`,
          timestamp: new Date()
        });

        console.log(`❌ 评论内容重复限制触发：昵称"${authorToCheck}"的内容重复`);

        // 跳过后续处理
        const review = await new ImageReview(reviewData).save();
        return review;
      }
    }
  }

  // ... 其余AI审核通过的处理逻辑
}
```

### 2. 实现位置和逻辑

- **位置**：在 `server/routes/client.js` 第822行之后，评论类型专用的检查
- **触发条件**：AI审核通过且信心度>=0.9时
- **限制维度**：昵称 + 链接（不是用户ID + 链接）
- **检查内容**：数量限制（最多2条）+ 内容重复检查

### 2. 数据库查询优化

为提高查询性能，可以考虑添加复合索引：

```javascript
// 在 ImageReview 模型中添加索引（用于评论昵称限制查询）
imageReviewSchema.index({ 'aiParsedNoteInfo.author': 1, imageType: 1, noteUrl: 1, status: 1 });
```

### 3. 错误处理

- 返回清晰的错误信息，告知用户限制原因
- 记录验证失败的日志，便于监控和调试

### 4. 边界情况处理

- 空评论内容或纯空格内容
- 链接格式标准化（去除查询参数等）
- 区分已完成和进行中的评论状态

## 实现位置

### 文件修改
1. `server/routes/client.js` - 在 `/tasks/batch-submit` 端点中添加验证逻辑
2. `server/models/ImageReview.js` - 可选：添加数据库索引优化

### 具体修改点
在 `server/routes/client.js` 第822行之后，AI审核通过的处理逻辑中添加评论昵称限制检查。

## 测试用例

### 正常情况
- 昵称A首次在链接A发评论：允许
- 昵称A第二次在链接A发不同评论：允许
- 昵称A第三次在链接A发评论：拒绝

### 异常情况
- 昵称A在链接A发两篇相同评论：第二篇拒绝
- 昵称A在不同链接发相同评论：允许
- 不同昵称在同一链接发评论：各自独立计算
- 同一用户用不同昵称在同一链接发评论：允许（因为昵称不同）

## 监控和日志

建议添加日志记录：
```javascript
console.log(`评论昵称限制检查 - 昵称:"${matchedAuthor}", 链接:${noteUrl}, 现有评论数:${existingComments.length}`);
```

## 扩展考虑

未来可以考虑：
- 更灵活的内容相似度检测（而非完全匹配）
- 时间窗口限制（例如24小时内只能发几条）
- 基于用户等级的限制差异
- 管理员豁免机制