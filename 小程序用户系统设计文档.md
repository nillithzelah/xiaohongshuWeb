# 小程序用户系统设计文档

## 📋 需求概述

当前小程序使用硬编码的测试账号，无法支持真实用户使用。需要实现完整的用户注册和登录系统，支持微信授权登录，并为每个用户自动分配专属设备。

## 🎯 设计目标

1. **微信原生登录**: 使用微信小程序原生登录能力
2. **用户信息获取**: 获取用户微信号、手机号等信息
3. **自动注册**: 首次登录自动创建兼职用户账户
4. **设备分配**: 为每个用户自动分配专属小红书设备
5. **数据隔离**: 用户间数据完全隔离，只能访问自己的数据
6. **权限控制**: 兼职用户只能提交任务，不能管理他人

## 🔄 用户登录流程

### 1. 小程序端流程

#### 1.1 微信授权登录
```javascript
// pages/login/login.js
Page({
  data: {
    canUseLogin: false,
    userInfo: null
  },

  onLoad() {
    // 检查是否支持微信登录
    wx.getSystemInfo({
      success: (res) => {
        this.setData({
          canUseLogin: wx.canIUse('login')
        });
      }
    });
  },

  // 微信登录按钮
  onWechatLogin() {
    wx.login({
      success: (res) => {
        if (res.code) {
          console.log('获取微信code成功:', res.code);
          this.loginWithCode(res.code);
        } else {
          wx.showToast({
            title: '登录失败',
            icon: 'none'
          });
        }
      },
      fail: (err) => {
        console.error('微信登录失败:', err);
        wx.showToast({
          title: '微信登录失败',
          icon: 'none'
        });
      }
    });
  },

  // 使用code登录服务器
  loginWithCode(code) {
    wx.showLoading({ title: '登录中...' });

    wx.request({
      url: 'https://www.wubug.cc/xiaohongshu/api/auth/wechat-login',
      method: 'POST',
      data: { code },
      success: (res) => {
        wx.hideLoading();

        if (res.data && res.data.success) {
          const { token, user } = res.data;

          // 保存token和用户信息
          wx.setStorageSync('token', token);
          wx.setStorageSync('user', user);

          wx.showToast({
            title: '登录成功',
            icon: 'success'
          });

          // 检查是否需要完善信息
          this.checkUserInfoComplete(user);
        } else {
          wx.showToast({
            title: res.data?.message || '登录失败',
            icon: 'none'
          });
        }
      },
      fail: (err) => {
        wx.hideLoading();
        console.error('网络请求失败:', err);
        wx.showToast({
          title: '网络连接失败',
          icon: 'none'
        });
      }
    });
  },

  // 检查用户信息是否完整
  checkUserInfoComplete(user) {
    const needPhone = !user.phone;
    const needWechat = !user.wechat;

    if (needPhone || needWechat) {
      wx.showModal({
        title: '完善信息',
        content: '为了更好地为您服务，请完善您的联系方式',
        confirmText: '去完善',
        cancelText: '稍后',
        success: (res) => {
          if (res.confirm) {
            // 跳转到信息完善页面
            wx.navigateTo({
              url: '/pages/profile/profile'
            });
          } else {
            // 直接进入主页面
            wx.switchTab({
              url: '/pages/index/index'
            });
          }
        }
      });
    } else {
      // 信息完整，直接进入主页面
      wx.switchTab({
        url: '/pages/index/index'
      });
    }
  }
});
```

#### 1.2 获取手机号授权
```javascript
// 获取手机号按钮
getPhoneNumber(e) {
  if (e.detail.errMsg === 'getPhoneNumber:ok') {
    // 用户同意授权手机号
    wx.showLoading({ title: '绑定中...' });

    wx.request({
      url: 'https://www.wubug.cc/xiaohongshu/api/user/bind-phone',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`,
        'Content-Type': 'application/json'
      },
      data: {
        encryptedData: e.detail.encryptedData,
        iv: e.detail.iv
      },
      success: (res) => {
        wx.hideLoading();
        if (res.data.success) {
          wx.showToast({
            title: '手机号绑定成功',
            icon: 'success'
          });
          // 更新本地用户信息
          const user = wx.getStorageSync('user');
          user.phone = res.data.phone;
          wx.setStorageSync('user', user);
        } else {
          wx.showToast({
            title: res.data.message || '绑定失败',
            icon: 'none'
          });
        }
      },
      fail: () => {
        wx.hideLoading();
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        });
      }
    });
  } else {
    // 用户拒绝授权
    wx.showToast({
      title: '需要授权手机号才能使用完整功能',
      icon: 'none'
    });
  }
},
```

#### 1.3 获取微信号授权
```javascript
// 获取微信号按钮
getUserInfo(e) {
  if (e.detail.errMsg === 'getUserInfo:ok') {
    const userInfo = e.detail.userInfo;

    wx.showLoading({ title: '绑定中...' });

    wx.request({
      url: 'https://www.wubug.cc/xiaohongshu/api/user/bind-wechat',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`,
        'Content-Type': 'application/json'
      },
      data: {
        nickName: userInfo.nickName,
        avatarUrl: userInfo.avatarUrl
      },
      success: (res) => {
        wx.hideLoading();
        if (res.data.success) {
          wx.showToast({
            title: '微信信息绑定成功',
            icon: 'success'
          });
          // 更新本地用户信息
          const user = wx.getStorageSync('user');
          user.wechat = userInfo.nickName;
          user.avatar = userInfo.avatarUrl;
          wx.setStorageSync('user', user);
        } else {
          wx.showToast({
            title: res.data.message || '绑定失败',
            icon: 'none'
          });
        }
      },
      fail: () => {
        wx.hideLoading();
        wx.showToast({
          title: '网络错误',
          icon: 'none'
        });
      }
    });
  }
},
```

### 2. 服务器端流程

#### 2.1 微信登录API (auth.js)
```javascript
const axios = require('axios');

router.post('/wechat-login', async (req, res) => {
  try {
    const { code } = req.body;

    if (!code) {
      return res.status(400).json({ success: false, message: '缺少code参数' });
    }

    console.log('🔄 开始微信登录流程, code:', code);

    // 1. 调用微信API获取openid
    const wxAppId = process.env.WX_APP_ID;
    const wxAppSecret = process.env.WX_APP_SECRET;

    if (!wxAppId || !wxAppSecret) {
      console.error('❌ 微信配置缺失');
      return res.status(500).json({ success: false, message: '服务器配置错误' });
    }

    const wxResponse = await axios.get('https://api.weixin.qq.com/sns/jscode2session', {
      params: {
        appid: wxAppId,
        secret: wxAppSecret,
        js_code: code,
        grant_type: 'authorization_code'
      },
      timeout: 10000
    });

    const { openid, session_key, errcode, errmsg } = wxResponse.data;

    if (errcode) {
      console.error('❌ 微信API错误:', errmsg);
      return res.status(400).json({ success: false, message: '微信授权失败' });
    }

    if (!openid) {
      return res.status(400).json({ success: false, message: '获取用户信息失败' });
    }

    console.log('✅ 获取openid成功:', openid);

    // 2. 查找或创建用户
    let user = await User.findOne({ openid });

    if (!user) {
      console.log('👤 用户不存在，创建新用户');

      // 生成用户名
      const username = `user_${openid.substr(-8)}`;

      user = new User({
        openid,
        username,
        nickname: username,
        role: 'part_time',
        points: 0,
        totalEarnings: 0,
        createdAt: new Date()
      });

      await user.save();
      console.log('✅ 新用户创建成功:', user._id);

      // 3. 为新用户自动创建设备
      const Device = require('../models/Device');
      const device = new Device({
        accountName: `xiaohongshu_user_${user._id.toString().substr(-8)}`,
        assignedUser: user._id,
        status: 'online',
        influence: ['new'],
        createdAt: new Date()
      });

      await device.save();
      console.log('✅ 设备创建成功:', device.accountName);

    } else {
      console.log('👤 用户已存在:', user._id);
    }

    // 4. 生成JWT token
    const token = jwt.sign(
      { userId: user._id },
      process.env.JWT_SECRET || 'default_secret',
      { expiresIn: '7d' }
    );

    console.log('🎫 JWT token生成成功');

    res.json({
      success: true,
      token,
      user: {
        id: user._id,
        username: user.username,
        nickname: user.nickname,
        role: user.role,
        points: user.points,
        totalEarnings: user.totalEarnings,
        phone: user.phone,
        wechat: user.wechat,
        avatar: user.avatar
      }
    });

  } catch (error) {
    console.error('❌ 微信登录错误:', error);
    res.status(500).json({ success: false, message: '登录服务暂时不可用' });
  }
});
```

#### 2.2 绑定手机号API
```javascript
const crypto = require('crypto');

// 绑定手机号
router.post('/user/bind-phone', authenticateToken, async (req, res) => {
  try {
    const { encryptedData, iv } = req.body;
    const { sessionKey } = req.user; // 需要在登录时保存sessionKey

    if (!encryptedData || !iv) {
      return res.status(400).json({ success: false, message: '缺少必要参数' });
    }

    // 解密手机号数据
    const decryptedData = decryptPhoneData(encryptedData, iv, sessionKey);
    const phoneInfo = JSON.parse(decryptedData);

    // 更新用户手机号
    await User.findByIdAndUpdate(req.user._id, {
      phone: phoneInfo.phoneNumber,
      phoneVerified: true
    });

    res.json({
      success: true,
      message: '手机号绑定成功',
      phone: phoneInfo.phoneNumber
    });

  } catch (error) {
    console.error('绑定手机号错误:', error);
    res.status(500).json({ success: false, message: '绑定失败' });
  }
});

// 解密微信手机号数据
function decryptPhoneData(encryptedData, iv, sessionKey) {
  const decipher = crypto.createDecipheriv('aes-128-cbc', Buffer.from(sessionKey, 'base64'), Buffer.from(iv, 'base64'));
  let decrypted = decipher.update(Buffer.from(encryptedData, 'base64'), 'binary', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}
```

#### 2.3 绑定微信信息API
```javascript
// 绑定微信信息
router.post('/user/bind-wechat', authenticateToken, async (req, res) => {
  try {
    const { nickName, avatarUrl } = req.body;

    await User.findByIdAndUpdate(req.user._id, {
      wechat: nickName,
      avatar: avatarUrl,
      wechatBound: true
    });

    res.json({
      success: true,
      message: '微信信息绑定成功'
    });

  } catch (error) {
    console.error('绑定微信信息错误:', error);
    res.status(500).json({ success: false, message: '绑定失败' });
  }
});
```

## 🔧 配置要求

### 1. 微信小程序配置
```json
// project.config.json
{
  "appid": "your_app_id",
  "projectname": "xiaohongshu-parttime"
}
```

### 2. 服务器环境变量
```env
# 微信小程序配置
WX_APP_ID=your_wechat_app_id
WX_APP_SECRET=your_wechat_app_secret

# JWT配置
JWT_SECRET=your_secure_jwt_secret

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/xiaohongshu_audit
```

## 🛡️ 安全考虑

1. **数据加密**: 手机号等敏感信息加密存储
2. **权限控制**: 用户只能访问自己的数据
3. **Token安全**: JWT token定期更新
4. **API限流**: 防止恶意请求
5. **日志记录**: 记录所有用户操作

## 📱 前端页面流程

1. **启动页**: 检查本地token，决定显示登录页还是主页面
2. **登录页**: 微信授权登录按钮
3. **信息完善页**: 绑定手机号、微信号（可选）
4. **主页面**: 显示用户设备、积分、任务列表
5. **上传页面**: 选择设备、上传截图、提交任务

## 🔄 数据流图

```
微信小程序 → 微信API → 服务器 → MongoDB
     ↓            ↓         ↓         ↓
   获取code → 换取openid → 创建用户 → 保存数据
     ↓            ↓         ↓         ↓
   绑定信息 → 更新资料 → 分配设备 → 返回token
     ↓            ↓         ↓         ↓
   进入系统 → 数据隔离 → 权限控制 → 正常使用
```

## 📋 开发计划

### Phase 1: 基础登录 (1-2天)
- [ ] 配置微信小程序AppID/Secret
- [ ] 实现微信登录API
- [ ] 小程序登录页面
- [ ] 用户自动注册

### Phase 2: 信息完善 (1天)
- [ ] 手机号绑定功能
- [ ] 微信信息绑定功能
- [ ] 信息完善页面

### Phase 3: 设备分配 (1天)
- [ ] 自动创建设备逻辑
- [ ] 设备分配API
- [ ] 设备状态管理

### Phase 4: 数据隔离 (1天)
- [ ] 用户数据过滤
- [ ] 权限控制加强
- [ ] 测试多用户场景

### Phase 5: 测试上线 (1天)
- [ ] 完整流程测试
- [ ] 性能优化
- [ ] 错误处理完善

## 🎯 验收标准

1. ✅ 用户可以用微信扫码登录
2. ✅ 首次登录自动创建账户和设备
3. ✅ 用户数据完全隔离
4. ✅ 可以绑定手机号和微信号
5. ✅ 所有原有功能正常工作
6. ✅ 支持多用户同时使用

---

**文档版本**: v1.0
**最后更新**: 2025-12-17
**负责人**: AI助手