# 小程序功能修改文档

## 概述
本文档描述了小程序和网页端需要实现的功能修改，包括个人信息管理、设备管理、分销系统、投诉功能、积分兑换、审核记录、AI审核、登录注册等模块。

## 功能修改清单

### 1. 个人信息修改 ⭐新增功能
- **位置**: 个人资料页面
- **功能**: 添加个人信息修改按钮（现有页面只有显示功能）
- **可修改内容**:
  - 用户名
  - 密码
  - 上级邀请码
- **邀请码逻辑**:
  - 所有用户都可以显示自己的邀请码
  - 邀请码用于建立上下级关系（通过邀请码绑定上级用户）
- **显示信息**:
  - 积分号Z（中间几位打码显示）- User模型已有integral_z字段
  - 积分号W（中间几位打码显示）- User模型已有integral_w字段
  - 自己的带教老师名称
- **其他功能**:
  - 加入登出按钮
  - 页面重新显示时自动隐藏编辑弹窗 ⭐新增功能
  - 优化编辑弹窗输入框样式（增加高度和字体大小） ⭐UI优化
  - 账号信息按钮整合到菜单列表中 ⭐UI优化
  - 统一优化所有页面输入框样式（个人资料、积分兑换等页面） ⭐UI优化

### 2. 设备管理 (改名为账号管理) ⭐部分修改
- **位置**: 设备管理页面 (重命名为账号管理)
- **功能**:
  - 新增账号 ⭐新增功能
  - 修改账号 (仅限昵称) ⭐新增功能
  - 删除账号 ⭐新增功能
- **审核机制** ⭐新增功能:
  - 新增和修改操作需要AI审核
  - 审核页面：验证昵称和账号是否匹配
  - AI自动审核：通过则准许操作，否则驳回


### 3. 分销系统展示 ⭐新增功能
- **位置**: 新增按钮或页面
- **功能**: 显示上下级关系和积分
- **显示内容**:
  - 上级用户昵称
  - 下级用户昵称
  - 下级用户的下级用户昵称
  - 与自己有关的分销积分

### 4. 投诉功能 ⭐新增功能
- **位置**: 新增投诉按钮
- **功能**:
  - 点击进入投诉页面
  - 仅支持文字输入
  - 提交到服务器

### 5. 待兑换显示 ⭐新增功能
- **位置**: 个人资料页面的资产卡片中
- **功能**: 显示兼职用户管理的代打款（待兑换款项）
- **说明**: 显示Transaction表中status='pending'的交易总金额

### 6. 积分兑换 ⭐新增功能
- **位置**: 积分页面
- **功能**:
  - 兑换按钮
  - 输入兑换积分数量 (默认全部)
  - 提交兑换请求

## 技术实现要点
- 所有修改需要与后端API对接
- 确保数据安全性，特别是密码修改
- 邀请码绑定需要验证逻辑
- 分销积分计算需要后端支持
- 投诉内容需要服务器端存储
- 小程序UI中不显示人民币符号，只显示数字

## 7. 上传功能修改 ⭐部分修改
- **位置**: 上传页面
- **功能**:
  - 选择操作设备改名为账号列表 ⭐修改现有功能（现有代码中仍使用"设备"）
  - 无需手动选择，审核时自动对比全部账号昵称 ⭐修改现有AI审核逻辑
  - 账号列表加入新增账号按钮 ⭐新增功能
  - 评论图片设为可选，不强制上传 ⭐已实现（现有代码中注释掉了强制验证）
  - 上传图片功能移至填写数据下方 ⭐UI调整
  - 默认选择评论任务类型 ⭐新增功能
  - 上传成功后保留当前选择的任务类型 ⭐新增功能

## 8. 审核记录修改 ⭐修改现有功能
- **位置**: 首页审核记录
- **功能**:
  - 加入审核未通过原因显示
  - 加入AI每隔24小时的笔记审核结果显示
- **原因类型**:
  - 链接不对
  - 昵称不对
  - 根据任务类型显示：笔记类型显示"标题不存在"，评论类型显示"评论不存在"
- **AI审核结果**: 显示笔记的持续存在性检查结果
- **影响范围**: 小程序和服务器端审核逻辑都需要修改

## 9. AI审核功能 ⭐修改现有功能
- **功能**: 加入所有AI审核结果显示（包括初始审核和每隔24小时的持续存在性检查结果，现有AI审核功能需要增强）
- **审核逻辑**:
  - AI自动审核给出结果，直接显示失败原因
  - 不再改为人工介入
  - 作者昵称改为数组形式 ⭐修改现有逻辑
  - 比对兼职用户的全部设备账号名字，只要有一个匹配即成功 ⭐修改现有逻辑
- **失败原因类型** (与小程序审核相同):
  - 链接不对
  - 昵称不对
  - 笔记类型显示"标题不存在"，评论类型显示"评论不存在"
- **其他说明**:
  - 客资仍需人工审核

## 10. 登录和注册修改 ⭐修改现有功能
- **位置**: 登录页面和注册页面
- **登录修改**:
  - 一键登录失败时，如果没有手机号，跳转到注册页面
- **注册修改**:
  - 加入可选的邀请码输入 ⭐新增功能
  - 注册失败提示：如果没有手机号，显示"手机号为注册，请联系带教老师"

## 11. 网页端积分管理页面 ⭐新增功能
- **位置**: 小红书审核网页 (admin/finance)
- **权限**: 仅老板和主管可访问
- **功能**:
  - 新增页面用于修改任务积分
  - 可修改任务积分和对应的分销积分
- **积分兑换规则修改**:
  - 改为100积分换1元

## 12. 兼职用户管理修改 ⭐部分修改
- **位置**: 网页端兼职用户管理页面
- **功能**:
  - 加入提现按钮 ⭐新增功能
  - 加入邀请码显示和修改功能 ⭐新增功能
- **权限**: 仅主管和老板可看到和使用提现按钮
- **说明**: 管理员点击提现按钮后，将用户的待打款交易（Transaction表中status='pending'的记录）状态更新为'completed'（已提现）

## 13. 投诉管理页面 ⭐新增功能
- **位置**: 网页端新增投诉页面
- **权限**: 仅主管和老板可访问
- **功能**: 查看小程序用户提交的投诉消息

## 服务器端需要实现的功能和接口

### 1. 用户信息管理接口 ⭐新增/修改
- **PUT /xiaohongshu/api/user/profile**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ username, nickname, newPassword?, parentInvitationCode? }`
  - 功能: 更新用户信息 (用户名、昵称、密码、上级邀请码)
- **GET /xiaohongshu/api/user/me**
  - 请求头: `Authorization: Bearer {token}`
  - 返回: 用户信息 (包含积分号Z、W脱敏显示)
- **POST /xiaohongshu/api/auth/logout**
  - 请求头: `Authorization: Bearer {token}`
  - 功能: 用户登出接口

### 2. 邀请码系统 ⭐新增
- **POST /xiaohongshu/api/user/bind-invitation**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ invitationCode }`
  - 功能: 绑定上级邀请码
- **GET /xiaohongshu/api/user/invitation-code**
  - 请求头: `Authorization: Bearer {token}`
  - 返回: `{ invitationCode }`
  - 功能: 获取用户的邀请码
- **GET /xiaohongshu/api/user/referral-tree**
  - 请求头: `Authorization: Bearer {token}`
  - 返回: `{ parent, children, grandchildren }`
  - 功能: 获取上下级关系树

### 3. 分销积分系统 ⭐新增
- **GET /xiaohongshu/api/user/distribution-points**
  - 请求头: `Authorization: Bearer {token}`
  - 返回: `{ distributionPoints }`
  - 功能: 获取分销积分信息 ⭐已实现
- **GET /xiaohongshu/api/user/referral-stats**
  - 请求头: `Authorization: Bearer {token}`
  - 返回: 推荐统计和积分数据
  - 功能: 获取推荐统计和积分 ⭐已实现

### 4. 投诉系统 ⭐新增
- **POST /xiaohongshu/api/complaints**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ content }`
  - 功能: 提交投诉
- **GET /xiaohongshu/api/complaints**
  - 请求头: `Authorization: Bearer {token}` (仅老板和主管)
  - 查询参数: `?page=1&limit=10&status&keyword`
  - 返回: 投诉列表
  - 功能: 获取投诉列表

### 5. 积分兑换系统 ⭐新增
- **POST /xiaohongshu/api/users/{userId}/exchange-points**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ pointsToExchange }`
  - 功能: 积分兑换 (100积分=1元)
- **GET /xiaohongshu/api/user/me** (包含pendingAmount)
  - 请求头: `Authorization: Bearer {token}`
  - 返回: `{ pendingAmount }`
  - 功能: 获取用户待打款金额

### 6. 设备/账号管理 ⭐新增/修改
- **POST /xiaohongshu/api/devices**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ accountName, accountId?, status?, influence? }`
  - 功能: 新增设备/账号
- **PUT /xiaohongshu/api/devices/{id}**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ accountName?, status?, influence? }`
  - 功能: 修改设备昵称
- **DELETE /xiaohongshu/api/devices/{id}**
  - 请求头: `Authorization: Bearer {token}`
  - 功能: 删除设备
- **POST /xiaohongshu/api/devices/verify**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ accountName, nickname }`
  - 功能: AI审核设备昵称和账号匹配

### 7. 审核系统增强 ⭐修改现有功能
- **PUT /xiaohongshu/api/reviews/failure-reasons**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ reviewId, failureReason }`
  - 功能: 更新审核失败原因
- **GET /xiaohongshu/api/reviews/ai-results**
  - 请求头: `Authorization: Bearer {token}`
  - 返回: AI审核结果列表
  - 功能: 获取AI审核结果
- **PUT /xiaohongshu/api/reviews/ai-config**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: `{ authorNicknames, deviceAccounts }`
  - 功能: 配置AI审核参数
- **POST /xiaohongshu/api/client/tasks/batch-submit**
  - 请求头: `Authorization: Bearer {token}`
  - 请求体: 任务提交数据 (图片可选)
  - 功能: 批量提交任务

### 8. 登录注册增强 ⭐修改现有功能
- **POST /xiaohongshu/api/auth/user-register**
  - 请求体: `{ phoneNumber, username, password, nickname?, invitationCode? }`
  - 功能: 带邀请码注册
- **GET /xiaohongshu/api/auth/check-phone**
  - 查询参数: `?phone={phoneNumber}`
  - 返回: 手机号是否已注册
  - 功能: 检查手机号是否已注册

### 9. 网页端管理功能 ⭐新增
- **GET /xiaohongshu/api/admin/task-points**
  - 请求头: `Authorization: Bearer {token}` (仅老板主管)
  - 返回: 任务积分配置列表
  - 功能: 获取任务积分管理数据
- **PUT /xiaohongshu/api/admin/task-points/{id}**
  - 请求头: `Authorization: Bearer {token}` (仅老板主管)
  - 请求体: `{ price, commission_1, commission_2 }`
  - 功能: 修改任务积分和分销积分
- **POST /xiaohongshu/api/admin/withdraw/{userId}**
  - 请求头: `Authorization: Bearer {token}` (仅老板主管)
  - 功能: 执行提现操作
- **PUT /xiaohongshu/api/admin/user-invitation**
  - 请求头: `Authorization: Bearer {token}` (仅老板主管)
  - 请求体: `{ userId, invitationCode }`
  - 功能: 修改用户邀请码

### 10. 数据模型扩展 ⭐部分新增
- **User模型扩展**:
  - 新增字段: `invitationCode`, `parent_id`, `integral_z`, `integral_w`
  - 扩展字段: `wallet` (添加 `total_withdrawn`)
- **Device模型扩展**:
  - 新增字段: `auditStatus`, `aiReviewResult`
- **Review模型扩展**:
  - 新增字段: `failureReason`, `aiReviewResult`
- **Complaint模型** ⭐新增:
  - 字段: `userId`, `content`, `status`, `adminResponse`, `respondedBy`, `respondedAt`

## 数据库表结构详情

### Users表现有字段
- **基本信息**: `_id`, `username`, `password`, `role`, `nickname`, `openid`, `phone`, `wechat`, `notes`
- **层级关系**: `hr_id`, `mentor_id`, `assigned_to_mentor_at`, `parent_id`
- **财务信息**: `wallet` (包含 `total_income`, `alipay_account`, `balance`, `real_name`, `total_earned`, `total_withdrawn`), `points`
- **培训信息**: `training_status`, `xiaohongshuAccounts` (数组，包含账号信息)
- **系统字段**: `is_deleted`, `deleted_at`, `deleted_by`, `createdAt`, `__v`

### Devices表现有字段
- **基本信息**: `_id`, `phone`, `accountId`, `accountName`, `assignedUser`, `status`, `influence`, `onlineDuration`, `points`, `remark`
- **系统字段**: `isLocked`, `createdBy`, `createdAt`, `updatedAt`, `__v`

### ImageReviews表现有字段
- **基本信息**: `_id`, `userId`, `imageUrls`, `imageType`, `imageMd5s`, `snapshotPrice`, `snapshotCommission1`, `snapshotCommission2`
- **内容信息**: `noteUrl`, `userNoteInfo`, `aiParsedNoteInfo`
- **审核信息**: `aiReviewResult`, `status`, `mentorReview`, `financeProcess`, `auditHistory`
- **持续检查**: `continuousCheck`
- **设备信息**: `deviceInfo`
- **系统字段**: `createdAt`, `__v`

### Transactions表现有字段
- **基本信息**: `_id`, `user_id`, `amount`, `type`, `status`, `payment_status`, `createdAt`, `__v`

### Complaints表现有字段
- 目前为空表，等待Complaint模型实现后填充

## 后续扩展
文档编写完成，等待用户添加更多功能需求。