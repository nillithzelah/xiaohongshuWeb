# HTTP配置 - 支持多个应用的配置
server {
    listen 80;
    server_name www.wubug.cc;

    # 默认根路径 - 返回404，由其他应用处理
    location / {
        return 404;
    }

    # 小红书审核系统 - 子路径 /xiaohongshu
    location /xiaohongshu/ {
        alias /var/www/xiaohongshu-web/admin/public/;
        index index.html index.htm;

        # SPA路由支持
        try_files $uri $uri/ /xiaohongshu/index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 小红书API代理 - 核心修改：匹配 /xiaohongshu/api/ 前缀
    location /xiaohongshu/api/ {
        # 魔法：把 /xiaohongshu/api/ 替换成 /api/ 发给后端
        proxy_pass http://localhost:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # wubug-admin 系统 - 子路径 /wubug-admin
    location /wubug-admin/ {
        alias /var/www/wubug-admin/public/;
        index index.html index.htm;

        # SPA路由支持
        try_files $uri $uri/ /wubug-admin/index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 财务系统 - 子路径 /finance
    location /finance/ {
        alias /var/www/finance/;
        index index.html index.htm;

        # SPA路由支持
        try_files $uri $uri/ /finance/index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # wubug-admin API代理 - 匹配 /api/ 前缀（根路径API）
    location /api/ {
        # 直接代理到 wubug-admin 后端
        proxy_pass http://localhost:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 日志配置
    access_log /var/log/nginx/xiaohongshu-web.access.log;
    error_log /var/log/nginx/xiaohongshu-web.error.log;
}