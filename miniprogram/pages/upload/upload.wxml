<!-- pages/upload/upload.wxml -->
<view class="container">

  <!-- 步骤 0: 选择设备 -->
  <view class="section">
    <view class="section-title">
      <text class="step-num">1</text>
      <text class="step-text">选择操作设备</text>
      <text class="required-mark">*</text>
    </view>

    <view class="device-list" wx:if="{{devices.length > 0}}">
     <view
       wx:for="{{devices}}"
       wx:key="_id"
       class="device-card {{selectedDevice._id === item._id ? 'selected' : ''}} {{!item.selectable ? 'disabled' : ''}}"
       bindtap="{{item.selectable ? 'selectDevice' : ''}}"
       data-device="{{item}}"
     >
        <view class="device-info">
          <text class="device-name">{{item.accountName}}</text>
          <text class="device-status" wx:if="{{item.status === 'online'}}" style="color: #52c41a;">● 在线</text>
          <text class="device-status" wx:elif="{{item.status === 'offline'}}" style="color: #faad14;">● 离线</text>
          <text class="device-status" wx:elif="{{item.status === 'protected'}}" style="color: #1890ff;">● 保护</text>
          <text class="device-status" wx:elif="{{item.status === 'frozen'}}" style="color: #ff4d4f;">● 冻结</text>
        </view>
        <view class="check-mark" wx:if="{{selectedDevice._id === item._id}}">✔</view>
      </view>
    </view>

    <view wx:else class="no-devices">
      <text>{{noDevicesMessage || '暂无可用设备，请联系带教老师分配设备'}}</text>
    </view>
  </view>

  <!-- 测试模式：选择用户（仅在测试模式下显示） -->
  <view class="section" wx:if="{{testMode}}">
    <view class="section-title">
      <text class="step-num">0.5</text>
      <text class="step-text">测试模式 - 选择用户</text>
      <switch class="test-mode-switch" checked="{{testMode}}" bindchange="toggleTestMode"></switch>
    </view>

    <view class="user-selector">
      <view class="current-user">
        <text class="user-label">当前用户：</text>
        <text class="user-name">{{selectedUser.username || '未选择'}} ({{selectedUser.role || '无角色'}})</text>
      </view>

      <view class="user-list" wx:if="{{users.length > 0}}">
        <view
          wx:for="{{users}}"
          wx:key="_id"
          class="user-card {{selectedUser._id === item._id ? 'selected' : ''}}"
          bindtap="selectUser"
          data-user="{{item}}"
        >
          <view class="user-info">
            <text class="user-name">{{item.username}}</text>
            <text class="user-nickname" wx:if="{{item.nickname}}">({{item.nickname}})</text>
            <text class="user-role">{{item.role}}</text>
          </view>
          <view class="user-meta">
            <text class="user-points">积分: {{item.points || 0}}</text>
          </view>
          <view class="check-mark" wx:if="{{selectedUser._id === item._id}}">✔</view>
        </view>
      </view>

      <view wx:else class="no-users">
        <text>加载用户列表中...</text>
      </view>
    </view>
  </view>

  <!-- 步骤 1: 选择类型 -->
  <view class="section">
    <view class="section-title">
      <text class="step-num">2</text>
      <text class="step-text">选择任务类型</text>
      <text class="required-mark">*</text>
    </view>

    <view class="type-grid">
      <block wx:for="{{taskTypes}}" wx:key="id">
        <view
          class="type-card {{selectedType.value === item.value ? 'selected' : ''}}"
          bindtap="selectType"
          data-type="{{item}}"
        >
          <view class="type-header">
            <text class="type-icon">{{item.icon}}</text>
            <text class="type-price">{{item.price}}</text>
          </view>
          <view class="type-name">{{item.name}}</view>
          <view class="type-desc">{{item.desc}}</view>

          <!-- 选中时的对勾标记 -->
          <view class="check-mark" wx:if="{{selectedType.value === item.value}}">✔</view>
        </view>
      </block>
    </view>
  </view>

  <!-- 步骤 2: 上传图片 -->
  <view class="section">
    <view class="section-title">
      <text class="step-num">3</text>
      <text class="step-text">上传凭证图片</text>
      <text class="optional-mark">(可选)</text>
    </view>

    <!-- 图片列表 - 使用 displayList -->
    <view class="image-list">
      <block wx:for="{{displayList}}" wx:key="{{index}}">
        <!-- 图片项 -->
        <view class="image-item" wx:if="{{item.type !== 'add'}}">
          <image src="{{item}}" mode="aspectFill" class="preview-img"></image>
          <view class="delete-btn" bindtap="deleteImage" data-index="{{index}}">×</view>
          <view class="image-index">{{index + 1}}</view>
        </view>

        <!-- 添加按钮项 -->
        <view class="image-item add-btn" bindtap="chooseImage" wx:if="{{item.type === 'add'}}">
          <view class="add-icon">+</view>
          <text class="add-text">添加</text>
        </view>
      </block>
    </view>

    <!-- 图片统计 -->
    <view class="image-stats" wx:if="{{imageUrls.length > 0}}">
      <text>已选择 {{imageUrls.length}} 张图片</text>
    </view>
  </view>

  <!-- 步骤 3: 填写链接和信息 -->
  <view class="section" wx:if="{{selectedType.value === 'note' || selectedType.value === 'comment' || selectedType.value === 'customer_resource'}}">
    <view class="section-title">
      <text class="step-num">4</text>
      <text class="step-text">{{selectedType.value === 'customer_resource' ? '填写客户信息' : '填写笔记信息'}}</text>
      <text class="required-mark" wx:if="{{selectedType.value === 'note' || selectedType.value === 'comment' || selectedType.value === 'customer_resource'}}">*</text>
    </view>

    <!-- 笔记链接（仅笔记和评论类型显示） -->
    <view class="form-group" wx:if="{{selectedType.value === 'note' || selectedType.value === 'comment'}}">
      <view class="input-label">笔记链接<text class="required-mark">*</text></view>
      <input
        class="url-input"
        placeholder="请输入笔记链接"
        value="{{noteUrl}}"
        bindinput="onNoteUrlInput"
        confirm-type="done"
        maxlength="500"
      />
    </view>


    <!-- 笔记标题（仅笔记类型显示） -->
    <view class="form-group" wx:if="{{selectedType.value === 'note'}}">
      <view class="input-label">笔记标题<text class="required-mark">*</text></view>
      <input
        class="text-input"
        placeholder="请输入笔记标题"
        value="{{noteTitle}}"
        bindinput="onNoteTitleInput"
        maxlength="200"
      />
    </view>

    <!-- 评论内容（仅评论类型显示） -->
    <view class="form-group" wx:if="{{selectedType.value === 'comment'}}">
      <view class="input-label">评论内容<text class="required-mark">*</text></view>
      <textarea
        class="text-input comment-input"
        placeholder="请输入评论内容"
        value="{{commentContent}}"
        bindinput="onCommentContentInput"
        maxlength="500"
        auto-height="true"
      />
    </view>

    <!-- 客资信息（仅客资类型显示） -->
    <view wx:if="{{selectedType.value === 'customer_resource'}}">
      <view class="form-group">
        <view class="input-label">客户电话</view>
        <input
          class="text-input"
          placeholder="请输入客户电话号码"
          value="{{customerPhone}}"
          bindinput="onCustomerPhoneInput"
          type="number"
          maxlength="11"
        />
      </view>

      <view class="form-group">
        <view class="input-label">客户微信</view>
        <input
          class="text-input"
          placeholder="请输入客户微信号"
          value="{{customerWechat}}"
          bindinput="onCustomerWechatInput"
          maxlength="50"
        />
        <view class="input-hint">
          <text>电话号和微信号至少填写一项</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 上传进度显示 -->
  <view class="upload-progress" wx:if="{{uploading || uploadProgress > 0}}">
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{uploadProgress}}%;"></view>
      </view>
      <view class="progress-text">
        <text>{{uploadStatus || '上传中...'}}</text>
        <text wx:if="{{processingMd5}}">正在处理图片...</text>
      </view>
      <view class="progress-percent">{{uploadProgress}}%</view>
    </view>
  </view>

  <!-- 步骤 4: 提交按钮 -->
  <view class="footer-action">
    <button
      class="submit-btn {{selectedDevice && selectedType ? 'active' : ''}}"
      bindtap="submitTask"
      loading="{{uploading}}"
      disabled="{{uploading}}"
    >
      {{uploading ? '上传中...' : '立即提交'}} {{imageUrls.length > 0 ? imageUrls.length + '张图片' : '任务'}}
    </button>
  </view>

</view>