<!-- pages/upload/upload.wxml -->
<view class="container">

  <!-- 步骤 0: 选择设备 -->
  <view class="section">
    <view class="section-title">
      <text class="step-num">0</text>
      <text class="step-text">选择操作设备</text>
    </view>

    <view class="device-list" wx:if="{{devices.length > 0}}">
      <view
        wx:for="{{devices}}"
        wx:key="_id"
        class="device-card {{selectedDevice._id === item._id ? 'selected' : ''}}"
        bindtap="selectDevice"
        data-device="{{item}}"
      >
        <view class="device-info">
          <text class="device-name">{{item.accountName}}</text>
          <text class="device-status" wx:if="{{item.status === 'online'}}" style="color: #52c41a;">● 在线</text>
          <text class="device-status" wx:elif="{{item.status === 'offline'}}" style="color: #faad14;">● 离线</text>
          <text class="device-status" wx:elif="{{item.status === 'protected'}}" style="color: #1890ff;">● 保护</text>
          <text class="device-status" wx:elif="{{item.status === 'frozen'}}" style="color: #ff4d4f;">● 冻结</text>
        </view>
        <view class="device-meta">
          <text class="device-points">积分: {{item.points}}</text>
        </view>
        <view class="check-mark" wx:if="{{selectedDevice._id === item._id}}">✔</view>
      </view>
    </view>

    <view wx:else class="no-devices">
      <text>暂无可用设备，请联系管理员分配设备</text>
    </view>
  </view>

  <!-- 步骤 1: 选择类型 -->
  <view class="section">
    <view class="section-title">
      <text class="step-num">1</text>
      <text class="step-text">选择任务类型</text>
    </view>

    <view class="type-grid">
      <block wx:for="{{taskTypes}}" wx:key="id">
        <view
          class="type-card {{selectedType.value === item.value ? 'selected' : ''}}"
          bindtap="selectType"
          data-type="{{item}}"
        >
          <view class="type-header">
            <text class="type-icon">{{item.icon}}</text>
            <text class="type-price">¥{{item.price}}</text>
          </view>
          <view class="type-name">{{item.name}}</view>
          <view class="type-desc">{{item.desc}}</view>

          <!-- 选中时的对勾标记 -->
          <view class="check-mark" wx:if="{{selectedType.value === item.value}}">✔</view>
        </view>
      </block>
    </view>
  </view>

  <!-- 步骤 2: 上传图片 -->
  <view class="section">
    <view class="section-title">
      <text class="step-num">2</text>
      <text class="step-text">上传凭证图片</text>
    </view>

    <!-- 图片列表 - 使用 displayList -->
    <view class="image-list">
      <block wx:for="{{displayList}}" wx:key="{{index}}">
        <!-- 图片项 -->
        <view class="image-item" wx:if="{{item.type !== 'add'}}">
          <image src="{{item}}" mode="aspectFill" class="preview-img"></image>
          <view class="delete-btn" bindtap="deleteImage" data-index="{{index}}">×</view>
          <view class="image-index">{{index + 1}}</view>
        </view>

        <!-- 添加按钮项 -->
        <view class="image-item add-btn" bindtap="chooseImage" wx:if="{{item.type === 'add'}}">
          <view class="add-icon">+</view>
          <text class="add-text">添加</text>
        </view>
      </block>
    </view>

    <!-- 图片统计 -->
    <view class="image-stats" wx:if="{{imageUrls.length > 0}}">
      <text>已选择 {{imageUrls.length}} 张图片</text>
    </view>
  </view>

  <!-- 步骤 3: 填写链接 -->
  <view class="section" wx:if="{{selectedType.value === 'note' || selectedType.value === 'comment'}}">
    <view class="section-title">
      <text class="step-num">3</text>
      <text class="step-text">填写小红书笔记链接</text>
      <text class="required-mark" wx:if="{{selectedType.value === 'note'}}">*</text>
    </view>

    <view class="form-group">
      <input
        class="url-input"
        placeholder="{{selectedType.value === 'note' ? '请输入小红书笔记链接（必填）' : '请输入小红书笔记链接（选填）'}}"
        value="{{noteUrl}}"
        bindinput="onNoteUrlInput"
        confirm-type="done"
      />
      <view class="input-hint">
        <text>示例：https://www.xiaohongshu.com/explore/...</text>
      </view>
    </view>
  </view>

  <!-- 步骤 4: 提交按钮 -->
  <view class="footer-action">
    <button
      class="submit-btn {{selectedDevice && selectedType && imageUrls.length > 0 && (selectedType.value !== 'note' || (noteUrl && noteUrl.trim())) ? 'active' : ''}}"
      bindtap="submitTask"
      loading="{{uploading}}"
    >
      立即提交 {{imageUrls.length > 0 ? imageUrls.length + '张图片' : '任务'}}
    </button>
  </view>

</view>