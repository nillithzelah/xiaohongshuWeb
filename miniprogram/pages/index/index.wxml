<!-- pages/index/index.wxml -->
<scroll-view class="container" scroll-y="true" enable-flex="true" bindscrolltolower="onScrollToLower" refresher-enabled="{{true}}" bindrefresherrefresh="onPullDownRefresh" bindrefresherrestore="onPullDownRefreshRestore">

  <!-- ğŸ”’ å†…éƒ¨å‘˜å·¥ä½¿ç”¨è¯´æ˜ -->
  <view class="internal-notice">
    <view class="notice-content">
      <text class="notice-icon">ğŸ”’</text>
      <text class="notice-text">æœ¬å°ç¨‹åºä»…é™å†…éƒ¨å‘˜å·¥ä½¿ç”¨ï¼Œå·²è¿›è¡Œè´¦å·é‰´æƒéªŒè¯</text>
    </view>
  </view>

  <!-- ç®€åŒ–çš„ç”¨æˆ·ä¿¡æ¯å¤´å›¾ -->
  <view class="header-card">
    <view class="user-info">
      <view class="avatar-container">
        <image class="avatar" src="{{userInfo.avatarUrl || 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'}}" mode="cover"></image>
      </view>
      <view class="user-text">
        <view class="greeting">ä½ å¥½ï¼Œ{{userInfo.nickName || 'å¥‹æ–—è€…'}}</view>
        <view class="subtitle">{{userInfo.phone ? 'ä»Šå¤©ä¹Ÿæ˜¯åŠªåŠ›æç§¯åˆ†çš„ä¸€å¤©ï¼ğŸ’ª' : 'è¯·å…ˆå®Œæˆæ‰‹æœºå·æˆæƒ'}}</view>
      </view>
    </view>
  </view>

  <!-- ç”»å»Šè½®æ’­å›¾ -->
  <view class="banner-container">
    <swiper
      class="card-swiper"
      indicator-dots="{{true}}"
      autoplay="{{true}}"
      interval="4000"
      duration="500"
      circular="{{true}}"
      previous-margin="60rpx"
      next-margin="60rpx"
      bindchange="cardSwiper"
    >
      <block wx:for="{{bannerList}}" wx:key="id">
        <swiper-item class="card-swiper-item">
          <view class="swiper-box {{cardCur==index?'cur':''}}">
            <image src="{{item.url}}" class="swiper-image" mode="aspectFill"></image>
          </view>
        </swiper-item>
      </block>
    </swiper>

    <!-- é€šå‘Šæ  -->
    <view class="announcement-bar">
      <view class="announcement-content">
        ğŸ“¢ ä»Šæ—¥ç¬”è®°ä»»åŠ¡å•ä»·ä¸Šè°ƒè‡³ 10 ç§¯åˆ†ï¼
      </view>
    </view>
  </view>

  <!-- ğŸ“‹ è®¾å¤‡å®¡æ ¸çŠ¶æ€å¡ç‰‡ -->
  <view class="device-review-card" wx:if="{{showDeviceReviewCard}}">
    <view class="card-header">
      <text class="card-title">ğŸ“± è®¾å¤‡å®¡æ ¸çŠ¶æ€</text>
    </view>
    <view class="card-content">
      <view class="review-info">
        <view class="device-name">è®¾å¤‡: {{deviceReviewStatus.accountName || 'æœªçŸ¥è®¾å¤‡'}}</view>
        <view class="review-status {{deviceReviewStatus.status}}">
          çŠ¶æ€:
          {{
            deviceReviewStatus.status === 'pending' ? 'å¾…å®¡æ ¸' :
            deviceReviewStatus.status === 'ai_approved' ? 'AIå®¡æ ¸é€šè¿‡ï¼Œç­‰å¾…äººå·¥å®¡æ ¸' :
            deviceReviewStatus.status === 'approved' ? 'å®¡æ ¸é€šè¿‡' :
            deviceReviewStatus.status === 'rejected' ? 'å®¡æ ¸æ‹’ç»' : 'å®¡æ ¸ä¸­'
          }}
        </view>
        <view class="review-time" wx:if="{{deviceReviewStatus.createdAt}}">
          æäº¤æ—¶é—´: {{deviceReviewStatus.createdAt}}
        </view>
        <view class="review-reason" wx:if="{{deviceReviewStatus.status === 'rejected' && deviceReviewStatus.reviewReason}}">
          æ‹’ç»åŸå› : {{deviceReviewStatus.reviewReason}}
        </view>
      </view>
      <view class="review-actions" wx:if="{{deviceReviewStatus.status === 'rejected'}}">
        <button class="retry-btn" bindtap="goToDeviceList">é‡æ–°æäº¤</button>
      </view>
    </view>
  </view>

  <!-- ğŸ“‹ å®¡æ ¸è®°å½•åˆ—è¡¨ -->
  <view class="list-container">
    <view class="list-header">è¿‘æœŸå®¡æ ¸è®°å½•</view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && reviews.length === 0}}">
      <image class="empty-icon" src="https://img.icons8.com/ios/100/cccccc/empty-box.png" mode="widthFix"></image>
      <text>æš‚æ— è®°å½•ï¼Œå¿«å»ä¸Šä¼ ç¬¬ä¸€å•å§~</text>
      <button class="go-upload-btn" bindtap="goToUpload">å»ä¸Šä¼ </button>
    </view>

    <!-- åˆ—è¡¨å†…å®¹ -->
    <block wx:for="{{reviews}}" wx:key="_id">
      <view class="review-card">
        <view class="card-thumb-container">
          <image class="card-thumb" src="{{item.imageUrl}}" mode="aspectFill"></image>
          <view class="completion-icon" wx:if="{{item.status === 'manager_approved' || item.status === 'completed'}}">âœ“</view>
        </view>
        <view class="card-content">
          <view class="card-row">
            <text class="task-type">{{item.imageType === 'customer_resource' ? 'å®¢èµ„' : (item.imageType === 'note' ? 'ç¬”è®°' : 'è¯„è®º')}}</text>
            <view class="status-tag {{(item.aiReviewResult && item.aiReviewResult.passed === false) ? 'rejected' : item.status}}">
              {{
                item.status === 'completed' ? 'å·²åˆ°è´¦' :
                ((item.status === 'rejected' || item.status === 'manager_rejected' || (item.aiReviewResult && item.aiReviewResult.passed === false)) ? 'å·²é©³å›' :
                (item.status === 'manager_approved' ? 'å®¡æ ¸é€šè¿‡' :
                (item.status === 'mentor_approved' ? 'ä¸»ç®¡å®¡æ ¸ä¸­' : 'å®¡æ ¸ä¸­')))
              }}
            </view>
          </view>
          <view class="card-row time-row">
            <text class="submit-time">{{item.commentAuthor || item.deviceName}} Â· {{item.formattedTime}}</text>
            <text class="amount" wx:if="{{item.status === 'manager_approved' || item.status === 'completed'}}">+ {{item.snapshotPrice}}</text>
          </view>

          <!-- é©³å›åŸå›  -->
          <view class="audit-failure-reason" wx:if="{{(item.aiReviewResult && item.aiReviewResult.passed === false) || item.status === 'rejected' || item.status === 'manager_rejected'}}">
            <text class="failure-label">å®¡æ ¸å¤±è´¥åŸå› ï¼š</text>
            <text class="failure-reason">{{item.rejectionReason || (item.aiReviewResult && item.aiReviewResult.reasons && item.aiReviewResult.reasons.length > 0 ? item.aiReviewResult.reasons[item.aiReviewResult.reasons.length - 1] : 'å®¡æ ¸æœªé€šè¿‡')}}</text>
          </view>

          <!-- AIå®¡æ ¸ç»“æœå±•ç¤º - å·²æ³¨é‡Š -->
          <!-- <view class="ai-review-info" wx:if="{{item.aiReviewResult}}">
            <view class="ai-review-status">
              <text class="ai-label">æœºå®¡ç»“æœï¼š</text>
              <text class="ai-status {{item.aiReviewResult.passed ? 'passed' : 'failed'}}">
                {{item.aiReviewResult.passed ? 'é€šè¿‡' : 'æœªé€šè¿‡'}}
              </text>
            </view>
          </view> -->

          <!-- æŒç»­æ£€æŸ¥ç»“æœ - å·²æ³¨é‡Š -->
          <!-- <view class="continuous-check-info" wx:if="{{item.continuousCheck}}">
            <view class="check-status">
              <text class="check-label">æŒç»­æ£€æŸ¥ï¼š</text>
              <text class="check-result {{item.continuousCheck.status === 'active' ? 'active' : 'failed'}}">
                {{item.continuousCheck.status === 'active' ? 'æ­£å¸¸' : 'å¼‚å¸¸'}}
              </text>
              <text class="check-time" wx:if="{{item.continuousCheck.lastCheckTime}}">
                ({{item.continuousCheck.lastCheckTime.substring(5, 16).replace('T', ' ')}})
              </text>
            </view>
          </view> -->
        </view> <!-- é—­åˆ card-content -->
      </view> <!-- é—­åˆ review-card -->
    </block>

    <!-- åŠ è½½æ›´å¤š/åˆ°åº•æç¤º -->
    <view class="loading-more" wx:if="{{reviews.length > 0}}">
      <view wx:if="{{loading && hasMore}}" class="loading-indicator">
        <text class="loading-text">æ­£åœ¨åŠ è½½æ›´å¤š...</text>
      </view>
      <view wx:elif="{{!hasMore}}" class="no-more-data">
        <text class="no-more-text">--- æ²¡æœ‰æ›´å¤šæ•°æ®äº† ---</text>
      </view>
    </view>
  </view>

  <!-- ğŸ“± æ‰‹æœºå·æˆæƒæ¨¡æ€æ¡† -->
  <view class="phone-auth-modal" wx:if="{{showPhoneAuthModal}}">
    <view class="modal-mask" wx:if="{{!forceAuth}}" bindtap="closePhoneAuthModal"></view>
    <view class="modal-mask force-mask" wx:if="{{forceAuth}}"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ğŸ“± æ‰‹æœºå·æˆæƒ</text>
        <view class="close-btn" bindtap="closePhoneAuthModal">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="auth-icon">ğŸ“</view>
        <view class="auth-text">
          <text wx:if="{{forceAuth}}">æœ¬å°ç¨‹åºä»…é™å†…éƒ¨å‘˜å·¥ä½¿ç”¨ï¼Œä¸ºå®Œæˆèº«ä»½éªŒè¯ï¼Œéœ€è¦è·å–æ‚¨çš„æ‰‹æœºå·ä¿¡æ¯ã€‚</text>
        </view>
        <view class="auth-tips">
          <text>æ‰‹æœºå·ä»…ç”¨äºè´¦å·å®‰å…¨éªŒè¯ï¼Œä¸ä¼šç”¨äºå…¶ä»–ç”¨é€”</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="cancel-btn" wx:if="{{!forceAuth}}" bindtap="closePhoneAuthModal">æš‚ä¸æˆæƒ</button>
        <button
          class="auth-btn"
          open-type="getPhoneNumber"
          bindgetphonenumber="onGetPhoneNumber"
        >
          ğŸ“± ç«‹å³æˆæƒ
        </button>
      </view>
    </view>
  </view>
</scroll-view>