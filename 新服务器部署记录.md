# 新服务器部署记录

## 📋 服务器信息

- **IP地址**: `112.74.163.102`
- **用户名**: `root`
- **密码**: `CgfmXpdTTG9xsmfm3Ebi`
- **SSH端口**: `22` (默认)
- **添加时间**: `2025-11-21`
- **用途**: 新增备用/测试服务器

## 🔑 连接方式

### SSH密码连接 (临时)
```bash
ssh root@112.74.163.102
# 密码: CgfmXpdTTG9xsmfm3Ebi
```

### SSH密钥连接 (推荐)
1. **在服务器上运行设置脚本**：
   ```bash
   # 复制项目中的 setup-server-ssh.sh 到服务器
   scp setup-server-ssh.sh root@112.74.163.102:~/

   # 在服务器上运行脚本
   ssh root@112.74.163.102
   # 密码: CgfmXpdTTG9xsmfm3Ebi
   chmod +x setup-server-ssh.sh
   ./setup-server-ssh.sh
   ```

2. **本地SSH配置** (已自动配置)：
   ```bash
   Host new-server
       HostName 112.74.163.102
       User root
       IdentityFile ~/.ssh/id_rsa_new_server
       IdentitiesOnly yes
   ```

3. **连接命令**：
   ```bash
   ssh new-server
   ```

## 🔍 服务器状态检查

### 系统信息
```bash
uname -a
cat /etc/os-release
```

### 资源使用情况
```bash
# 磁盘使用
df -h

# 内存使用
free -h

# CPU信息
lscpu
```

### 网络配置
```bash
# IP信息
ip addr show

# 路由表
ip route show

# DNS配置
cat /etc/resolv.conf
```

## 📁 目录结构检查

### 根目录
```bash
ls -la /
```

### 用户目录
```bash
ls -la /root/
```

### 系统目录
```bash
ls -la /etc/
ls -la /var/
ls -la /usr/
```

## 🔧 已安装软件检查

### 包管理器
```bash
# 检查包管理器
which apt yum dnf pacman

# 已安装包列表
apt list --installed 2>/dev/null | head -20
```

### 常用工具
```bash
# 检查常用工具
which node npm git docker nginx mysql postgresql redis
node --version 2>/dev/null || echo "Node.js not installed"
npm --version 2>/dev/null || echo "npm not installed"
git --version 2>/dev/null || echo "Git not installed"
```

## 🚀 部署准备

### 创建项目目录
```bash
mkdir -p /var/www
cd /var/www
```

### 安装必要软件
```bash
# 更新系统
apt update && apt upgrade -y

# 安装基础工具
apt install -y curl wget git vim htop iotop

# 安装Node.js (如果需要)
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# 安装Nginx (如果需要)
apt install -y nginx

# 安装PM2 (如果需要)
npm install -g pm2
```

## 📊 监控和维护

### 系统监控
```bash
# 实时监控
htop

# 磁盘I/O监控
iotop

# 网络监控
iftop
```

### 日志查看
```bash
# 系统日志
journalctl -f

# 自定义应用日志 (部署后)
tail -f /var/log/application.log
```

## 🔒 安全配置

### SSH安全配置
```bash
# 编辑SSH配置
vim /etc/ssh/sshd_config

# 禁用root密码登录 (生产环境建议)
# PermitRootLogin prohibit-password

# 重启SSH服务
systemctl restart sshd
```

### 防火墙配置
```bash
# 检查防火墙状态
ufw status

# 开放必要端口
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw allow 3000/tcp  # Node.js应用

# 启用防火墙
ufw enable
```

## 📝 部署记录

### 部署时间
- **初始检查**: `2025-11-21`
- **SSH密钥配置**: `2025-11-21`
- **软件安装和前端部署**: `2025-11-22`
- **服务配置和启动**: `2025-11-22`
- **Node.js升级**: `2025-11-24`
- **后端代码部署**: `2025-11-24`
- **数据库初始化**: `2025-11-24`
- **环境变量配置**: `2025-11-24`
- **SSL证书配置**: `2025-11-24`
- **功能测试**: `2025-11-25`
- **状态验证**: `2025-11-24`
- **SSL证书升级**: `2025-11-25`
- **前端代码重新部署**: `2025-11-25`

### 已完成任务
- [x] 生成SSH密钥对
- [x] 配置本地SSH客户端
- [x] 创建服务器SSH设置脚本
- [x] 更新服务器连接文档
- [x] 在服务器上运行SSH设置脚本
- [x] 测试SSH密钥连接成功
- [x] 安装Node.js 18.20.8
- [x] 安装Nginx 1.18.0
- [x] 安装PM2 6.0.13
- [x] 安装SQLite3 3.31.1
- [x] 部署前端静态文件到 /var/www/html/
- [x] 升级Node.js到20.19.5版本
- [x] 创建后端项目目录 /var/www/douyin-admin-master/
- [x] 上传后端代码文件 (server.js, package.json, models/, config/, services/, scripts/)
- [x] 安装后端依赖包 (1636个包)
- [x] 运行数据库同步 (创建5个表)
- [x] 初始化默认token (access_token和refresh_token)
- [x] 创建管理员用户 (admin/Admin123!)
- [x] 配置环境变量 (.env文件)
- [x] 验证环境变量加载 (JWT_SECRET, DB_TYPE等)
- [x] 生成SSL证书 (自签名证书)
- [x] 配置Nginx HTTPS服务 (443端口)
- [x] 配置HTTP重定向到HTTPS
- [x] 测试HTTPS访问正常
- [x] 升级SSL证书到Let's Encrypt (www.wubug.cc)
- [x] 配置HTTP到HTTPS自动重定向
- [x] 重新构建前端应用
- [x] 部署最新前端代码到服务器
- [x] 修复路由配置问题 (/wubage路由路径不匹配)
- [x] 配置Nginx服务并启动
- [x] 启动PM2服务 (douyin-admin-api)

### 发现的问题
- [x] 系统版本：Ubuntu 20.04.6 LTS (5.4.0-216-generic)
- [x] 存储空间：40GB总容量，35GB可用
- [x] 内存配置：1.8GB总内存，1.5GB可用
- [x] 网络连接：正常
- [x] 已安装软件：Node.js 18.20.8, npm 11.6.3, Nginx 1.18.0, PM2 6.0.13, SQLite3 3.31.1
- [x] 运行服务：Nginx (运行1天20小时), PM2服务douyin-admin-api (运行45小时), 系统基础服务正常
- [x] 域名问题：www.wubug.cc域名正确解析到112.74.163.102，已配置nginx支持HTTPS访问

### 后续任务
- [x] 在服务器上运行SSH密钥设置脚本
- [x] 测试SSH密钥连接
- [x] 配置项目环境 (Node.js, Nginx, PM2已安装)
- [x] 部署后端应用代码到 /var/www/douyin-admin-master/
- [x] 初始化SQLite数据库 (5个表，1个管理员用户，2个token)
- [x] 配置环境变量文件 (.env)
- [x] 配置SSL证书 (Let's Encrypt证书，HTTPS访问正常，HTTP自动重定向)
- [x] 功能测试 (端口、HTTP/HTTPS重定向、API、前端页面)
- [ ] 设置监控和日志
- [ ] 用户重新登录 (由于JWT密钥不同，旧token无效 - 需要在新服务器上重新登录)

## 📞 联系信息

如有问题请及时联系开发团队。

---

*本文档由系统自动生成，最后更新时间: 2025-11-25*