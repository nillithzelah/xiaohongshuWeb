# 审核系统改进计划 - 详细实施方案

## 📋 修改项目清单

### 1. 内容关键词审核机制
**目标**：在笔记和评论审核的第一步，解析网页内容，识别特定关键词

**关键词列表**：
- 减肥被骗
- 护肤被骗
- 祛斑被骗
- 丰胸被骗
- 医美被骗
- 白发转黑被骗
- 手镯定制被骗

**审核逻辑**：
- 解析网页内容，检查是否包含上述关键词之一
- 如果不包含任何关键词，驳回审核
- 驳回原因：`帖子内容和工作要求匹配度过低`

**实施位置**：
- 修改 `xiaohongshuService.js` 的 `parseNoteContent` 方法，添加关键词检查逻辑
- 在 `asyncAiReviewService.js` 的审核逻辑中集成关键词检查

**详细实施方案**：
1. **修改 xiaohongshuService.js**：
   - 在 `parseNoteContent` 方法中添加关键词检查
   - 检查范围：页面标题、meta描述、页面正文内容
   - 返回关键词匹配结果

2. **修改 asyncAiReviewService.js**：
   - 在 `performFullAiReview` 方法中，在内容解析后立即进行关键词检查
   - 如果关键词检查失败，直接驳回审核
   - 添加相应的审核历史记录

3. **关键词检查实现**：
   - 使用正则表达式进行精确匹配
   - 支持关键词的变体形式（如"减肥被骗"、"被减肥骗"等）
   - 检查位置：标题、描述、页面内容

4. **测试用例**：
   - 包含关键词的帖子：审核通过
   - 不包含关键词的帖子：驳回，原因明确
   - 关键词变体：正确识别

---

### 2. 新增设备账号人工审核机制
**目标**：新增设备账号需要双重审核（AI审核 + 人工审核）

**网页端修改**：
- 在管理后台添加设备审核页面
- 显示待审核的新增设备账号
- 提供审核通过/拒绝功能

**小程序端修改**：
- 新增设备账号时，必须上传一张图片
- 提示文字：`请上传小红薯个人页面截图`
- 图片作为审核凭证

**审核流程**：
1. 用户提交设备账号 + 个人页面截图
2. 系统进行AI审核
3. AI审核通过后，进入人工审核队列
4. 管理员在网页端进行最终审核

**详细实施方案**：
1. **数据库模型修改**：
   - 在 `Device.js` 模型中添加审核相关字段：
     - `reviewStatus`: 'pending', 'approved', 'rejected'
     - `reviewImage`: 审核图片URL
     - `reviewReason`: 审核拒绝原因
     - `reviewedBy`: 审核人ID
     - `reviewedAt`: 审核时间

2. **小程序端修改**：
   - 修改 `device-list.js` 的新增设备表单，添加图片上传功能
   - 上传组件使用现有的OSS上传服务
   - 表单验证：必须上传截图才能提交

3. **后端API修改**：
   - 修改 `devices.js` 路由的POST方法，保存审核图片
   - 添加设备审核相关的API：
     - GET `/devices/pending-review` - 获取待审核设备列表
     - PUT `/devices/:id/review` - 审核设备（通过/拒绝）

4. **管理后台修改**：
   - 在 `admin/src/pages/` 下新建 `DeviceReview.js` 页面
   - 显示待审核设备列表，包含账号信息和审核图片
   - 提供审核通过/拒绝按钮
   - 审核后更新设备状态

5. **审核流程实现**：
   - 用户提交设备时，状态设为 'pending_review'
   - AI审核通过后，状态改为 'ai_approved'
   - 人工审核通过后，状态改为 'active'
   - 人工审核拒绝后，状态改为 'rejected'

6. **权限控制**：
   - 只有管理员（manager/boss）可以进行人工审核
   - 普通用户只能查看自己的设备状态

---

### 3. 评论二次审核机制
**目标**：评论审核改为两次尝试，提高成功率

**审核时间设置**：
- 第一次审核：等待90秒后执行
- 第二次审核：如果第一次失败，等待150秒后再次执行

**审核逻辑**：
- 第一次审核成功 → 直接通过
- 第一次审核失败 → 执行第二次审核
- 第二次审核成功 → 通过
- 第二次审核失败 → 驳回

**实施位置**：
- 修改 `asyncAiReviewService.js` 的评论审核逻辑
- 添加重试机制和时间控制

**详细实施方案**：
1. **修改 asyncAiReviewService.js**：
   - 在 `performFullAiReview` 方法中修改评论审核逻辑
   - 添加审核尝试计数器和时间控制
   - 实现重试机制

2. **审核流程实现**：
   - 评论类型任务进入审核队列时，记录审核尝试次数
   - 第一次审核：延迟90秒后执行
   - 如果失败，第二次审核：再延迟150秒后执行
   - 每次审核都记录详细的审核结果

3. **状态管理**：
   - 添加审核尝试次数字段
   - 记录每次审核的时间戳和结果
   - 审核成功或失败后更新最终状态

4. **错误处理**：
   - 审核过程中出现异常时，记录错误信息
   - 两次审核都失败时，驳回任务并给出详细原因

---

### 4. 笔记异步审核机制
**目标**：笔记审核改为异步处理，添加二次审核

**审核时间设置**：
- 第一次审核：等待120秒后执行
- 第二次审核：等待180秒后再次执行

**修改内容**：
- 将当前同步的笔记审核改为异步队列处理
- 参考评论的异步审核实现
- 添加两次审核尝试

**实施位置**：
- 修改笔记审核的调用方式
- 集成到 `AsyncAiReviewService` 队列中
- 添加重试逻辑

**详细实施方案**：
1. **修改 client.js 路由**：
   - 在 `/tasks/batch-submit` API中，笔记类型任务不再进行同步审核
   - 直接保存任务为 'pending' 状态，加入异步审核队列

2. **修改 asyncAiReviewService.js**：
   - 在 `performFullAiReview` 方法中添加笔记审核的二次尝试逻辑
   - 第一次审核：延迟120秒后执行
   - 如果失败，第二次审核：再延迟180秒后执行

3. **审核流程实现**：
   - 笔记任务提交后立即返回，状态为 'pending'
   - 异步审核服务处理队列中的笔记任务
   - 支持重试机制，记录审核尝试次数

4. **性能优化**：
   - 异步处理避免阻塞用户提交
   - 队列机制控制并发审核数量
   - 失败重试提高审核成功率

---

### 5. 时间记录北京时间标准化
**目标**：确保所有时间记录使用北京时间（UTC+8）

**检查范围**：
- 审核历史时间戳
- 数据库记录的创建时间
- 日志时间
- 定时任务时间

**实施内容**：
- 检查所有 `new Date()` 调用
- 确保时间显示为北京时间
- 数据库时间字段标准化

**详细实施方案**：
1. **代码检查和修改**：
   - 搜索项目中所有 `new Date()` 调用
   - 检查时间显示和存储逻辑
   - 统一使用北京时区处理

2. **数据库时间字段**：
   - 确认 MongoDB 时间字段存储为 UTC
   - 前端显示时转换为北京时间
   - API返回时间格式标准化

3. **日志时间处理**：
   - 检查所有 console.log 时间输出
   - 确保日志时间显示为北京时间

4. **定时任务时间**：
   - 检查定时任务的时间计算逻辑
   - 确保使用北京时区

5. **测试验证**：
   - 创建测试任务，验证时间显示
   - 检查数据库存储的时间格式
   - 验证日志时间输出

---

## 🔄 实施优先级

1. **高优先级**：内容关键词审核（影响审核准确性）
2. **高优先级**：时间记录标准化（数据一致性）
3. **中优先级**：设备账号人工审核（新功能）
4. **中优先级**：评论二次审核（提高成功率）
5. **低优先级**：笔记异步审核（性能优化）

---

## 📝 技术实现要点

- **关键词检测**：使用正则表达式或字符串包含检查
- **异步队列**：复用现有的 `AsyncAiReviewService` 架构
- **时间处理**：统一使用北京时区
- **人工审核**：新增管理后台页面和API
- **重试机制**：添加失败重试逻辑和时间间隔控制

---

## ✅ 验收标准

1. 包含指定关键词的帖子能够通过审核
2. 不包含关键词的帖子被驳回，原因明确
3. 新增设备账号需要上传截图并经过人工审核
4. 评论审核在失败时会自动重试
5. 笔记审核改为异步处理，支持重试
6. 所有时间显示为北京时间

---

## 📋 具体实施步骤

### 1.1 修改 xiaohongshuService.js 的 parseNoteContent 方法
**文件**：`server/services/xiaohongshuService.js`
**修改内容**：
- 在 `parseNoteContent` 方法中添加关键词检查逻辑
- 添加 `checkContentKeywords` 方法
- 返回关键词匹配结果

### 1.2 在 asyncAiReviewService.js 中集成关键词检查
**文件**：`server/services/asyncAiReviewService.js`
**修改内容**：
- 在 `performFullAiReview` 方法中添加关键词检查调用
- 关键词检查失败时直接驳回

### 2.1 在 Device 模型中添加审核相关字段
**文件**：`server/models/Device.js`
**修改内容**：
- 添加 `reviewStatus`, `reviewImage`, `reviewReason`, `reviewedBy`, `reviewedAt` 字段

### 2.2 修改小程序设备列表页面
**文件**：`miniprogram/pages/device-list/device-list.js`
**修改内容**：
- 在新增设备表单中添加图片上传功能
- 表单验证：必须上传截图

### 2.3 修改设备创建API
**文件**：`server/routes/devices.js`
**修改内容**：
- POST 方法中保存审核图片URL
- 添加审核相关API端点

### 2.4 创建管理后台设备审核页面
**文件**：`admin/src/pages/DeviceReview.js` (新建)
**修改内容**：
- 显示待审核设备列表
- 实现审核通过/拒绝功能

### 3.1 修改评论审核逻辑
**文件**：`server/services/asyncAiReviewService.js`
**修改内容**：
- 添加评论审核的二次尝试机制
- 实现时间延迟和重试逻辑

### 4.1 修改笔记审核为异步处理
**文件**：`server/routes/client.js`
**修改内容**：
- 笔记类型任务不再同步审核，直接加入队列

### 5.1 检查和修改时间处理逻辑
**文件**：全项目搜索 `new Date()`
**修改内容**：
- 统一时间处理逻辑，确保北京时间